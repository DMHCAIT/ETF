<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ETF Trading Dashboard - Configuration Panel</title>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .gradient-header {
            background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 50%, #06b6d4 100%);
        }
        .card-hover {
            transition: all 0.3s ease;
        }
        .card-hover:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
        }
        .pulse-dot {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }
        .price-up { color: #10b981; background-color: rgba(16, 185, 129, 0.1); }
        .price-down { color: #ef4444; background-color: rgba(239, 68, 68, 0.1); }
        .price-neutral { color: #6b7280; background-color: rgba(107, 114, 128, 0.1); }
        .config-panel { background: linear-gradient(145deg, #f8fafc 0%, #e2e8f0 100%); }
        .parameter-card { 
            background: white; 
            border: 2px solid #e2e8f0; 
            transition: all 0.3s ease;
        }
        .parameter-card:hover { border-color: #3b82f6; }
        .slider {
            -webkit-appearance: none;
            appearance: none;
            height: 6px;
            border-radius: 3px;
            background: #e2e8f0;
            outline: none;
            transition: background 0.3s;
        }
        .slider:hover { background: #cbd5e1; }
        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            height: 20px;
            width: 20px;
            border-radius: 50%;
            background: #3b82f6;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .slider::-webkit-slider-thumb:hover {
            background: #2563eb;
            transform: scale(1.1);
        }
        .slider::-moz-range-thumb {
            height: 20px;
            width: 20px;
            border-radius: 50%;
            background: #3b82f6;
            cursor: pointer;
            border: none;
        }
        .tab-button.active {
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            color: white;
            border-bottom: 3px solid #1d4ed8;
        }
        .notification {
            animation: slideInRight 0.3s ease-out;
        }
        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
    </style>
</head>
<body class="bg-gray-100 font-sans">
    <!-- Header -->
    <div class="gradient-header text-white shadow-lg">
        <div class="container mx-auto px-6 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center">
                    <div class="bg-white bg-opacity-20 rounded-lg p-2 mr-3">
                        <i class="fas fa-chart-line text-xl"></i>
                    </div>
                    <div>
                        <h1 class="text-xl font-bold">ETF Trading Dashboard</h1>
                        <p class="text-sm opacity-90">Real-time Configuration & Control</p>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <div class="flex items-center">
                        <span id="connectionDot" class="w-3 h-3 bg-green-400 rounded-full mr-2 pulse-dot"></span>
                        <span class="text-sm">System Active</span>
                    </div>
                    <div class="flex items-center">
                        <span class="w-3 h-3 bg-blue-400 rounded-full mr-2"></span>
                        <span id="connectionStatus" class="text-sm">Connected</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Navigation Tabs -->
    <div class="bg-white shadow-sm">
        <div class="container mx-auto px-6">
            <nav class="flex space-x-1">
                <button onclick="switchTab('dashboard')" id="tab-dashboard" class="tab-button active px-6 py-4 text-sm font-medium">
                    <i class="fas fa-tachometer-alt mr-2"></i>Dashboard
                </button>
                <button onclick="switchTab('config')" id="tab-config" class="tab-button px-6 py-4 text-sm font-medium text-gray-600 hover:text-gray-900">
                    <i class="fas fa-cogs mr-2"></i>Configuration
                </button>
                <button onclick="switchTab('trades')" id="tab-trades" class="tab-button px-6 py-4 text-sm font-medium text-gray-600 hover:text-gray-900">
                    <i class="fas fa-list mr-2"></i>Live Trading
                </button>
            </nav>
        </div>
    </div>

    <!-- Main Content -->
    <div class="container mx-auto px-6 py-6">
        <!-- Dashboard Tab -->
        <div id="content-dashboard" class="tab-content">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                <!-- Portfolio Value Card -->
                <div class="bg-white rounded-lg shadow p-6 card-hover">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-600">Portfolio Value</p>
                            <p class="text-2xl font-bold text-gray-900">â‚¹3,26,707</p>
                            <p class="text-sm text-green-600">+â‚¹1,234 (0.38%)</p>
                        </div>
                        <div class="bg-blue-100 p-3 rounded-lg">
                            <i class="fas fa-wallet text-blue-600 text-xl"></i>
                        </div>
                    </div>
                </div>

                <!-- Daily P&L Card -->
                <div class="bg-white rounded-lg shadow p-6 card-hover">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-600">Daily P&L</p>
                            <p class="text-2xl font-bold text-green-600">+â‚¹2,150</p>
                            <p class="text-sm text-green-600">+0.66% today</p>
                        </div>
                        <div class="bg-green-100 p-3 rounded-lg">
                            <i class="fas fa-trending-up text-green-600 text-xl"></i>
                        </div>
                    </div>
                </div>

                <!-- Active Positions Card -->
                <div class="bg-white rounded-lg shadow p-6 card-hover">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-600">Active Positions</p>
                            <p class="text-2xl font-bold text-gray-900">3</p>
                            <p class="text-sm text-gray-600">Max: 5 positions</p>
                        </div>
                        <div class="bg-orange-100 p-3 rounded-lg">
                            <i class="fas fa-chart-pie text-orange-600 text-xl"></i>
                        </div>
                    </div>
                </div>

                <!-- System Status Card -->
                <div class="bg-white rounded-lg shadow p-6 card-hover">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-600">System Status</p>
                            <p class="text-2xl font-bold text-green-600">Active</p>
                            <p class="text-sm text-gray-600">Monitoring markets</p>
                        </div>
                        <div class="bg-purple-100 p-3 rounded-lg">
                            <i class="fas fa-robot text-purple-600 text-xl"></i>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Current Trading Parameters -->
            <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-xl font-bold text-gray-900 flex items-center">
                        <i class="fas fa-sliders-h mr-2 text-blue-600"></i>Current Trading Parameters
                    </h2>
                    <div class="text-sm text-gray-500">
                        Last updated: <span id="lastUpdate">Never</span>
                    </div>
                </div>
                
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4" id="current-parameters">
                    <!-- Parameters will be loaded here -->
                </div>
            </div>
        </div>

        <!-- Configuration Tab -->
        <div id="content-config" class="tab-content hidden">
            <!-- Authentication Panel -->
            <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-xl font-bold text-gray-900 flex items-center">
                        <i class="fas fa-shield-alt mr-2 text-blue-600"></i>
                        Authentication & Trading Mode
                    </h2>
                    <div id="auth-status" class="flex items-center">
                        <span class="w-3 h-3 bg-yellow-500 rounded-full mr-2 pulse-dot"></span>
                        <span class="text-sm font-medium text-gray-600">Checking...</span>
                    </div>
                </div>
                
                <!-- Demo/Live Mode Toggle -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- Current Status -->
                    <div class="bg-gray-50 rounded-lg p-4">
                        <h3 class="font-semibold text-gray-800 mb-3">Current Status</h3>
                        <div id="current-mode" class="mb-3">
                            <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-yellow-100 text-yellow-800">
                                <span class="w-2 h-2 bg-yellow-400 rounded-full mr-2"></span>
                                Demo Mode
                            </span>
                        </div>
                        <div id="account-info" class="text-sm text-gray-600">
                            <div class="grid grid-cols-2 gap-2">
                                <div>User: <span id="account-user" class="font-medium">Demo User</span></div>
                                <div>Balance: â‚¹<span id="account-balance" class="font-medium">326,637.87</span></div>
                                <div>Available: â‚¹<span id="account-available" class="font-medium">300,000.00</span></div>
                                <div>Used: â‚¹<span id="account-used" class="font-medium">26,637.87</span></div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Authentication Controls -->
                    <div class="bg-gray-50 rounded-lg p-4">
                        <h3 class="font-semibold text-gray-800 mb-3">Trading Mode Controls</h3>
                        
                        <!-- Live Trading Activation -->
                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-3 mb-3">
                            <p class="text-sm text-blue-800 font-medium mb-2">ðŸš€ Activate Live Trading</p>
                            <p class="text-xs text-blue-600 mb-3">Required daily before market opens (9:15 AM IST)</p>
                            
                            <!-- Step 1: API Key Input -->
                            <div class="mb-3">
                                <label for="api-key-input" class="block text-xs font-medium text-gray-700 mb-1">Zerodha API Key</label>
                                <input type="text" id="api-key-input" name="api-key" placeholder="Enter your API key" 
                                       class="w-full px-3 py-2 text-sm border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                            
                            <button type="button" id="generate-login-btn" class="w-full bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 transition-colors text-sm font-medium">
                                <i class="fas fa-link mr-2"></i>Generate Login URL
                            </button>
                        </div>
                        
                        <!-- Step 2: Token Generation (Hidden initially) -->
                        <div id="token-section" class="bg-green-50 border border-green-200 rounded-lg p-3 mb-3 hidden">
                            <p class="text-sm text-green-800 font-medium mb-2">âœ… Login URL Generated</p>
                            <div class="mb-3">
                                <a id="login-url-link" href="#" target="_blank" 
                                   class="text-blue-600 hover:text-blue-800 text-sm underline break-all">
                                    Click here to login to Zerodha
                                </a>
                            </div>
                            
                            <div class="space-y-2">
                                <div>
                                    <label for="api-secret-input" class="block text-xs font-medium text-gray-700 mb-1">API Secret</label>
                                    <input type="password" id="api-secret-input" name="api-secret" placeholder="Enter your API secret" 
                                           class="w-full px-3 py-2 text-sm border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500">
                                </div>
                                <div>
                                    <label for="request-token-input" class="block text-xs font-medium text-gray-700 mb-1">Request Token</label>
                                    <input type="text" id="request-token-input" name="request-token" placeholder="Paste request_token from URL" 
                                           class="w-full px-3 py-2 text-sm border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500">
                                    <p class="text-xs text-gray-500 mt-1">Copy the request_token from the redirect URL after login</p>
                                </div>
                            </div>
                            
                            <button type="button" id="activate-live-btn" class="w-full bg-green-600 text-white py-2 px-4 rounded-md hover:bg-green-700 transition-colors text-sm font-medium mt-3">
                                <i class="fas fa-rocket mr-2"></i>Activate Live Trading
                            </button>
                        </div>
                        
                        <!-- Demo Mode Button -->
                        <button type="button" id="switch-demo-btn" class="w-full bg-gray-600 text-white py-2 px-4 rounded-md hover:bg-gray-700 transition-colors text-sm font-medium">
                            <i class="fas fa-flask mr-2"></i>Switch to Demo Mode
                        </button>
                    </div>
                </div>
                
                <!-- Authentication Messages -->
                <div id="auth-messages" class="mt-4"></div>
            </div>

            <!-- Trading Parameters Configuration -->
            <div class="config-panel rounded-xl p-8 shadow-lg">
                <div class="flex items-center justify-between mb-8">
                    <h2 class="text-2xl font-bold text-gray-900">
                        <i class="fas fa-cogs mr-3 text-blue-600"></i>Trading Parameters Configuration
                    </h2>
                    <div class="flex space-x-3">
                        <button onclick="resetToDefaults()" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg text-sm">
                            <i class="fas fa-undo mr-2"></i>Reset to Defaults
                        </button>
                        <button onclick="saveConfiguration()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm">
                            <i class="fas fa-save mr-2"></i>Save Configuration
                        </button>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8" id="configuration-controls">
                    <!-- Configuration controls will be loaded here -->
                </div>

                <!-- Status Messages -->
                <div id="config-status" class="mt-6"></div>
            </div>
        </div>

        <!-- Live Trading Tab -->
        <div id="content-trades" class="tab-content hidden">
            <div class="bg-white rounded-lg shadow-lg p-6">
                <h2 class="text-xl font-bold text-gray-900 mb-6">
                    <i class="fas fa-chart-line mr-2 text-green-600"></i>Live Trading Panel
                </h2>
                
                <!-- Quick Trade Actions -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    <div class="bg-gradient-to-r from-green-100 to-green-50 border border-green-200 rounded-lg p-4">
                        <h3 class="font-semibold text-green-800 mb-2">NIFTY ETF</h3>
                        <p class="text-2xl font-bold text-green-700" id="price-NIFTY">â‚¹18,247.50</p>
                        <p class="text-sm text-green-600 mb-3">+â‚¹23.45 (+0.13%)</p>
                        <div class="flex space-x-2">
                            <button onclick="executeManualTrade('NIFTY', 'BUY')" class="bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded text-xs">
                                BUY
                            </button>
                            <button onclick="executeManualTrade('NIFTY', 'SELL')" class="bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded text-xs">
                                SELL
                            </button>
                        </div>
                    </div>

                    <div class="bg-gradient-to-r from-blue-100 to-blue-50 border border-blue-200 rounded-lg p-4">
                        <h3 class="font-semibold text-blue-800 mb-2">BANK NIFTY</h3>
                        <p class="text-2xl font-bold text-blue-700" id="price-BANKNIFTY">â‚¹42,856.75</p>
                        <p class="text-sm text-red-600 mb-3">-â‚¹156.25 (-0.36%)</p>
                        <div class="flex space-x-2">
                            <button onclick="executeManualTrade('BANKNIFTY', 'BUY')" class="bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded text-xs">
                                BUY
                            </button>
                            <button onclick="executeManualTrade('BANKNIFTY', 'SELL')" class="bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded text-xs">
                                SELL
                            </button>
                        </div>
                    </div>

                    <div class="bg-gradient-to-r from-purple-100 to-purple-50 border border-purple-200 rounded-lg p-4">
                        <h3 class="font-semibold text-purple-800 mb-2">SENSEX ETF</h3>
                        <p class="text-2xl font-bold text-purple-700" id="price-SENSEX">â‚¹61,432.10</p>
                        <p class="text-sm text-green-600 mb-3">+â‚¹89.20 (+0.15%)</p>
                        <div class="flex space-x-2">
                            <button onclick="executeManualTrade('SENSEX', 'BUY')" class="bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded text-xs">
                                BUY
                            </button>
                            <button onclick="executeManualTrade('SENSEX', 'SELL')" class="bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded text-xs">
                                SELL
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Recent Trades -->
                <div>
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Recent Trades</h3>
                    <div id="trades-container" class="space-y-3">
                        <!-- Trades will be loaded here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ================= GLOBAL VARIABLES =================
        let socket;
        let currentConfig = {};

        // ================= GLOBAL FUNCTIONS (ACCESSIBLE TO HTML) =================
        
        // Tab switching function (must be global for onclick handlers)
        function switchTab(tabName) {
            try {
                // Hide all tab contents
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.add('hidden');
                });
                
                // Remove active class from all tabs
                document.querySelectorAll('.tab-button').forEach(button => {
                    button.classList.remove('active');
                    button.classList.add('text-gray-600', 'hover:text-gray-900');
                });
                
                // Show selected tab content
                const tabContent = document.getElementById(`content-${tabName}`);
                if (tabContent) {
                    tabContent.classList.remove('hidden');
                }
                
                // Add active class to selected tab
                const activeTab = document.getElementById(`tab-${tabName}`);
                if (activeTab) {
                    activeTab.classList.add('active');
                    activeTab.classList.remove('text-gray-600', 'hover:text-gray-900');
                }
            } catch (error) {
                console.error('Error switching tabs:', error);
            }
        }

        // Manual trade execution function (global for onclick handlers)
        function executeManualTrade(symbol, action) {
            try {
                if (!symbol || !action) {
                    showConfigStatus('Invalid trade parameters', 'error');
                    return;
                }

                const currentPrice = parseFloat(document.getElementById(`price-${symbol}`)?.textContent.replace('â‚¹', '').replace(',', '') || 0);
                
                if (currentPrice <= 0) {
                    showConfigStatus('Invalid current price', 'error');
                    return;
                }

                const confirmMsg = `Execute ${action} order for ${symbol} at â‚¹${currentPrice}?`;
                if (!confirm(confirmMsg)) return;

                fetch('/api/trade/execute', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        symbol: symbol,
                        action: action,
                        current_price: currentPrice
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        showConfigStatus(`Trade executed successfully: ${action} ${symbol}`, 'success');
                        addTradeToHistory(data.trade);
                    } else {
                        showConfigStatus(`Trade failed: ${data.message}`, 'error');
                    }
                })
                .catch(error => {
                    console.error('Trade execution error:', error);
                    showConfigStatus('Trade execution failed', 'error');
                });
            } catch (error) {
                console.error('Manual trade error:', error);
                showConfigStatus('Trade execution error', 'error');
            }
        }

        // Reset configuration to defaults (global for onclick handlers)
        function resetToDefaults() {
            if (confirm('Are you sure you want to reset all parameters to default values?')) {
                fetch('/api/config/reset', {
                    method: 'POST'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        currentConfig = data.parameters;
                        updateConfigurationDisplay();
                        showConfigStatus('Configuration reset to defaults!', 'success');
                    } else {
                        showConfigStatus(`Error: ${data.message}`, 'error');
                    }
                })
                .catch(error => {
                    console.error('Error resetting configuration:', error);
                    showConfigStatus('Error resetting configuration', 'error');
                });
            }
        }

        // Save configuration (global for onclick handlers)
        function saveConfiguration() {
            const configData = {
                drop_threshold: parseFloat(document.getElementById('slider-drop_threshold')?.value || -1.0),
                position_size_limit: parseFloat(document.getElementById('slider-position_size_limit')?.value || 0.2),
                stop_loss: parseFloat(document.getElementById('slider-stop_loss')?.value || -0.02),
                sell_target: parseFloat(document.getElementById('slider-sell_target')?.value || 0.015),
                capital_allocation: parseFloat(document.getElementById('slider-capital_allocation')?.value || 0.8),
                max_positions: parseInt(document.getElementById('slider-max_positions')?.value || 5)
            };

            fetch('/api/config/update', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(configData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    currentConfig = data.parameters;
                    showConfigStatus('Configuration saved successfully!', 'success');
                } else {
                    showConfigStatus(`Error: ${data.message}`, 'error');
                }
            })
            .catch(error => {
                console.error('Error saving configuration:', error);
                showConfigStatus('Error saving configuration', 'error');
            });
        }

        // ================= APPLICATION INITIALIZATION =================
        
        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            try {
                console.log('ðŸš€ Initializing ETF Trading Dashboard...');
                
                initializeSocket();
                loadConfiguration();
                setupSliderEvents();
                updateDisplay();
                initializeAuth();
                
                console.log('âœ… Dashboard initialized successfully');
            } catch (error) {
                console.error('âŒ Error initializing dashboard:', error);
            }
        });

        // ================= SOCKET.IO CONNECTION =================
        
        function initializeSocket() {
            try {
                socket = io();
                
                socket.on('connect', function() {
                    const statusEl = document.getElementById('connectionStatus');
                    const dotEl = document.getElementById('connectionDot');
                    if (statusEl) statusEl.textContent = 'Connected';
                    if (dotEl) dotEl.className = 'w-3 h-3 bg-green-400 rounded-full pulse-dot';
                });
                
                socket.on('disconnect', function() {
                    const statusEl = document.getElementById('connectionStatus');
                    const dotEl = document.getElementById('connectionDot');
                    if (statusEl) statusEl.textContent = 'Disconnected';
                    if (dotEl) dotEl.className = 'w-3 h-3 bg-red-400 rounded-full';
                });

                socket.on('config_updated', function(data) {
                    currentConfig = data.parameters;
                    updateConfigurationDisplay();
                    showConfigStatus('Configuration updated via WebSocket', 'success');
                });

                socket.on('trade_executed', function(data) {
                    showConfigStatus(`Trade executed: ${data.action} ${data.symbol}`, 'success');
                    addTradeToHistory(data);
                });

                socket.on('live_mode_activated', function(data) {
                    showAuthMessage(`ðŸŽ‰ ${data.status} - Account: ${data.account}`, 'success');
                    checkAuthStatus();
                });

                socket.on('demo_mode_activated', function(data) {
                    showAuthMessage('Switched to demo mode', 'success');
                    checkAuthStatus();
                });
            } catch (error) {
                console.error('Socket initialization error:', error);
            }
        }

        // ================= CONFIGURATION MANAGEMENT =================
        
        function loadConfiguration() {
            fetch('/api/config/get')
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        currentConfig = data.parameters;
                        updateConfigurationDisplay();
                    }
                })
                .catch(error => {
                    console.error('Error loading configuration:', error);
                });
        }

        function updateConfigurationDisplay() {
            try {
                // Update current parameters display
                const currentParams = document.getElementById('current-parameters');
                if (currentParams && currentConfig) {
                    currentParams.innerHTML = `
                        <div class="text-center">
                            <div class="text-lg font-semibold text-red-600">${(Math.abs(currentConfig.buy_threshold) * 100).toFixed(1)}%</div>
                            <div class="text-xs text-gray-600">Buy Threshold</div>
                        </div>
                        <div class="text-center">
                            <div class="text-lg font-semibold text-green-600">+${(currentConfig.sell_target * 100).toFixed(1)}%</div>
                            <div class="text-xs text-gray-600">Sell Target</div>
                        </div>
                        <div class="text-center">
                            <div class="text-lg font-semibold text-orange-600">${(Math.abs(currentConfig.loss_alert || currentConfig.stop_loss) * 100).toFixed(1)}%</div>
                            <div class="text-xs text-gray-600">Loss Alert</div>
                        </div>
                        <div class="text-center">
                            <div class="text-lg font-semibold text-blue-600">${(currentConfig.capital_allocation * 100).toFixed(0)}%</div>
                            <div class="text-xs text-gray-600">Capital Use</div>
                        </div>
                    `;
                }

                // Update configuration controls
                const configControls = document.getElementById('configuration-controls');
                if (configControls && currentConfig) {
                    configControls.innerHTML = generateConfigurationHTML();
                    setupSliderEvents();
                }
            } catch (error) {
                console.error('Error updating configuration display:', error);
            }
        }

        function generateConfigurationHTML() {
            return `
                <div class="parameter-card rounded-lg p-6">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">ðŸ“Š ETF Trading Rules</h3>
                    
                    <div class="space-y-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                Buy Threshold: <span id="value-buy_threshold" class="text-red-600 font-semibold">${(Math.abs(currentConfig.buy_threshold || -0.01) * 100).toFixed(1)}%</span>
                            </label>
                            <input type="range" id="slider-buy_threshold" class="slider w-full" 
                                   min="-0.05" max="-0.001" step="0.001" value="${currentConfig.buy_threshold || -0.01}">
                            <div class="flex justify-between text-xs text-gray-500 mt-1">
                                <span>-5.0%</span>
                                <span>-0.1%</span>
                            </div>
                            <p class="text-xs text-gray-600 mt-1">Buy ETF when price drops this % from previous close</p>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                Sell Target: <span id="value-sell_target" class="text-green-600 font-semibold">+${(currentConfig.sell_target * 100).toFixed(1)}%</span>
                            </label>
                            <input type="range" id="slider-sell_target" class="slider w-full" 
                                   min="0.005" max="0.1" step="0.005" value="${currentConfig.sell_target}">
                            <div class="flex justify-between text-xs text-gray-500 mt-1">
                                <span>+0.5%</span>
                                <span>+10.0%</span>
                            </div>
                            <p class="text-xs text-gray-600 mt-1">Auto-sell when profit reaches this %</p>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                Loss Alert: <span id="value-loss_alert" class="text-orange-600 font-semibold">${(Math.abs(currentConfig.loss_alert || -0.05) * 100).toFixed(1)}%</span>
                            </label>
                            <input type="range" id="slider-loss_alert" class="slider w-full" 
                                   min="-0.2" max="-0.01" step="0.01" value="${currentConfig.loss_alert || -0.05}">
                            <div class="flex justify-between text-xs text-gray-500 mt-1">
                                <span>-20.0%</span>
                                <span>-1.0%</span>
                            </div>
                            <p class="text-xs text-gray-600 mt-1">Alert only (no auto-sell) when loss reaches this %</p>
                        </div>
                        
                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-3">
                            <div class="flex items-center">
                                <input type="checkbox" id="one-buy-per-day" class="mr-2" checked disabled>
                                <label class="text-sm text-blue-800 font-medium">One Buy Per ETF Per Day</label>
                            </div>
                            <p class="text-xs text-blue-600 mt-1">System prevents repeat buy orders for same ETF until sold</p>
                        </div>
                    </div>
                </div>

                <div class="parameter-card rounded-lg p-6">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">Position Management</h3>
                    
                    <div class="space-y-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                Position Size Limit: <span id="value-position_size_limit" class="text-blue-600 font-semibold">${(currentConfig.position_size_limit * 100).toFixed(0)}%</span>
                            </label>
                            <input type="range" id="slider-position_size_limit" class="slider w-full" 
                                   min="0.05" max="0.5" step="0.05" value="${currentConfig.position_size_limit}">
                            <div class="flex justify-between text-xs text-gray-500 mt-1">
                                <span>5%</span>
                                <span>50%</span>
                            </div>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                Capital Allocation: <span id="value-capital_allocation" class="text-orange-600 font-semibold">${(currentConfig.capital_allocation * 100).toFixed(0)}%</span>
                            </label>
                            <input type="range" id="slider-capital_allocation" class="slider w-full" 
                                   min="0.1" max="1.0" step="0.05" value="${currentConfig.capital_allocation}">
                            <div class="flex justify-between text-xs text-gray-500 mt-1">
                                <span>10%</span>
                                <span>100%</span>
                            </div>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                Max Positions: <span id="value-max_positions" class="text-purple-600 font-semibold">${currentConfig.max_positions}</span>
                            </label>
                            <input type="range" id="slider-max_positions" class="slider w-full" 
                                   min="1" max="10" step="1" value="${currentConfig.max_positions}">
                            <div class="flex justify-between text-xs text-gray-500 mt-1">
                                <span>1</span>
                                <span>10</span>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function setupSliderEvents() {
            try {
                const sliders = document.querySelectorAll('input[type="range"]');
                sliders.forEach(slider => {
                    slider.addEventListener('input', function() {
                        const paramName = this.id.replace('slider-', '');
                        const valueElement = document.getElementById(`value-${paramName}`);
                        
                        if (valueElement) {
                            let displayValue;
                            if (paramName === 'max_positions') {
                                displayValue = this.value;
                            } else if (paramName === 'sell_target') {
                                displayValue = `+${(parseFloat(this.value) * 100).toFixed(1)}%`;
                            } else {
                                displayValue = `${(parseFloat(this.value) * 100).toFixed(1)}%`;
                            }
                            valueElement.textContent = displayValue;
                        }
                    });
                });
            } catch (error) {
                console.error('Error setting up slider events:', error);
            }
        }

        // ================= AUTHENTICATION FUNCTIONS =================

        function initializeAuth() {
            try {
                checkAuthStatus();
                
                // Set up authentication event listeners
                const generateBtn = document.getElementById('generate-login-btn');
                const activateBtn = document.getElementById('activate-live-btn');
                const switchDemoBtn = document.getElementById('switch-demo-btn');
                
                if (generateBtn) generateBtn.addEventListener('click', generateLoginUrl);
                if (activateBtn) activateBtn.addEventListener('click', activateLiveTrading);
                if (switchDemoBtn) switchDemoBtn.addEventListener('click', switchToDemo);
            } catch (error) {
                console.error('Auth initialization error:', error);
            }
        }

        function checkAuthStatus() {
            fetch('/api/auth/status')
                .then(response => response.json())
                .then(data => {
                    updateAuthStatus(data);
                })
                .catch(error => {
                    console.error('Error checking auth status:', error);
                    showAuthMessage('Error checking authentication status', 'error');
                });
        }

        function updateAuthStatus(data) {
            try {
                const statusElement = document.getElementById('auth-status');
                const currentModeElement = document.getElementById('current-mode');

                if (data.live_mode) {
                    if (statusElement) {
                        statusElement.innerHTML = `
                            <span class="w-3 h-3 bg-green-500 rounded-full mr-2 pulse-dot"></span>
                            <span class="text-sm font-medium text-green-600">Live Trading Active</span>
                        `;
                    }
                    if (currentModeElement) {
                        currentModeElement.innerHTML = `
                            <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-green-100 text-green-800">
                                <span class="w-2 h-2 bg-green-400 rounded-full mr-2"></span>
                                Live Trading
                            </span>
                        `;
                    }
                } else {
                    if (statusElement) {
                        statusElement.innerHTML = `
                            <span class="w-3 h-3 bg-yellow-500 rounded-full mr-2 pulse-dot"></span>
                            <span class="text-sm font-medium text-yellow-600">Demo Mode</span>
                        `;
                    }
                    if (currentModeElement) {
                        currentModeElement.innerHTML = `
                            <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-yellow-100 text-yellow-800">
                                <span class="w-2 h-2 bg-yellow-400 rounded-full mr-2"></span>
                                Demo Mode
                            </span>
                        `;
                    }
                }

                // Update account info
                const accountInfo = data.account_info || {};
                const userEl = document.getElementById('account-user');
                const balanceEl = document.getElementById('account-balance');
                const availableEl = document.getElementById('account-available');
                const usedEl = document.getElementById('account-used');

                if (userEl) userEl.textContent = accountInfo.user_name || 'Demo User';
                if (balanceEl) balanceEl.textContent = formatNumber(accountInfo.total_balance || 326637.87);
                if (availableEl) availableEl.textContent = formatNumber(accountInfo.available_cash || 300000.00);
                if (usedEl) usedEl.textContent = formatNumber(accountInfo.used_margin || 26637.87);
            } catch (error) {
                console.error('Error updating auth status:', error);
            }
        }

        function generateLoginUrl() {
            const apiKey = document.getElementById('api-key-input')?.value.trim();
            
            if (!apiKey) {
                showAuthMessage('Please enter your API key', 'error');
                return;
            }

            const generateBtn = document.getElementById('generate-login-btn');
            if (generateBtn) {
                generateBtn.disabled = true;
                generateBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Generating...';
            }

            fetch('/api/auth/generate-login', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ api_key: apiKey })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    const linkEl = document.getElementById('login-url-link');
                    const sectionEl = document.getElementById('token-section');
                    
                    if (linkEl) {
                        linkEl.href = data.login_url;
                        linkEl.textContent = data.login_url;
                    }
                    if (sectionEl) {
                        sectionEl.classList.remove('hidden');
                    }
                    showAuthMessage('Login URL generated! Click the link and copy the request_token from the redirect URL.', 'success');
                } else {
                    showAuthMessage(`Error: ${data.message}`, 'error');
                }
            })
            .catch(error => {
                console.error('Error generating login URL:', error);
                showAuthMessage('Error generating login URL', 'error');
            })
            .finally(() => {
                if (generateBtn) {
                    generateBtn.disabled = false;
                    generateBtn.innerHTML = '<i class="fas fa-link mr-2"></i>Generate Login URL';
                }
            });
        }

        function activateLiveTrading() {
            const apiSecret = document.getElementById('api-secret-input')?.value.trim();
            const requestToken = document.getElementById('request-token-input')?.value.trim();
            
            if (!apiSecret || !requestToken) {
                showAuthMessage('Please enter both API secret and request token', 'error');
                return;
            }

            const activateBtn = document.getElementById('activate-live-btn');
            if (activateBtn) {
                activateBtn.disabled = true;
                activateBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Activating...';
            }

            fetch('/api/auth/activate-live', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    api_secret: apiSecret,
                    request_token: requestToken
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    showAuthMessage('ðŸŽ‰ Live trading activated successfully!', 'success');
                    checkAuthStatus();
                    
                    // Reset form
                    const tokenSection = document.getElementById('token-section');
                    const apiKeyInput = document.getElementById('api-key-input');
                    const apiSecretInput = document.getElementById('api-secret-input');
                    const requestTokenInput = document.getElementById('request-token-input');
                    
                    if (tokenSection) tokenSection.classList.add('hidden');
                    if (apiKeyInput) apiKeyInput.value = '';
                    if (apiSecretInput) apiSecretInput.value = '';
                    if (requestTokenInput) requestTokenInput.value = '';
                } else {
                    showAuthMessage(`Error: ${data.message}`, 'error');
                }
            })
            .catch(error => {
                console.error('Error activating live trading:', error);
                showAuthMessage('Error activating live trading', 'error');
            })
            .finally(() => {
                if (activateBtn) {
                    activateBtn.disabled = false;
                    activateBtn.innerHTML = '<i class="fas fa-rocket mr-2"></i>Activate Live Trading';
                }
            });
        }

        function switchToDemo() {
            if (confirm('Are you sure you want to switch to demo mode? This will disconnect live trading.')) {
                const demoBtn = document.getElementById('switch-demo-btn');
                if (demoBtn) {
                    demoBtn.disabled = true;
                    demoBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Switching...';
                }

                fetch('/api/auth/switch-demo', {
                    method: 'POST'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        showAuthMessage('Switched to demo mode', 'success');
                        checkAuthStatus();
                    } else {
                        showAuthMessage(`Error: ${data.message}`, 'error');
                    }
                })
                .catch(error => {
                    console.error('Error switching to demo:', error);
                    showAuthMessage('Error switching to demo mode', 'error');
                })
                .finally(() => {
                    if (demoBtn) {
                        demoBtn.disabled = false;
                        demoBtn.innerHTML = '<i class="fas fa-flask mr-2"></i>Switch to Demo Mode';
                    }
                });
            }
        }

        // ================= UTILITY FUNCTIONS =================

        function showConfigStatus(message, type) {
            const statusContainer = document.getElementById('config-status');
            if (!statusContainer) return;

            const messageClass = type === 'success' ? 'bg-green-100 border-green-400 text-green-700' : 'bg-red-100 border-red-400 text-red-700';
            
            statusContainer.innerHTML = `
                <div class="border-l-4 p-4 ${messageClass} notification">
                    <div class="flex">
                        <div class="flex-shrink-0">
                            <i class="fas ${type === 'success' ? 'fa-check-circle' : 'fa-exclamation-triangle'}"></i>
                        </div>
                        <div class="ml-3">
                            <p class="text-sm">${message}</p>
                        </div>
                    </div>
                </div>
            `;
            
            setTimeout(() => {
                statusContainer.innerHTML = '';
            }, 5000);
        }

        function showAuthMessage(message, type) {
            const messagesContainer = document.getElementById('auth-messages');
            if (!messagesContainer) return;

            const messageClass = type === 'success' ? 'bg-green-100 border-green-400 text-green-700' : 'bg-red-100 border-red-400 text-red-700';
            
            messagesContainer.innerHTML = `
                <div class="border-l-4 p-4 ${messageClass} notification">
                    <div class="flex">
                        <div class="flex-shrink-0">
                            <i class="fas ${type === 'success' ? 'fa-check-circle' : 'fa-exclamation-triangle'}"></i>
                        </div>
                        <div class="ml-3">
                            <p class="text-sm">${message}</p>
                        </div>
                    </div>
                </div>
            `;
            
            setTimeout(() => {
                messagesContainer.innerHTML = '';
            }, 5000);
        }

        function formatNumber(num) {
            return new Intl.NumberFormat('en-IN').format(num);
        }

        function addTradeToHistory(trade) {
            try {
                const tradesContainer = document.getElementById('trades-container');
                if (!tradesContainer) return;

                const tradeElement = document.createElement('div');
                tradeElement.className = 'bg-gray-50 border border-gray-200 rounded-lg p-4 flex justify-between items-center';
                
                const actionColor = trade.action === 'BUY' ? 'text-green-600' : 'text-red-600';
                const actionBg = trade.action === 'BUY' ? 'bg-green-100' : 'bg-red-100';
                
                tradeElement.innerHTML = `
                    <div>
                        <div class="flex items-center space-x-3">
                            <span class="inline-flex items-center px-2 py-1 rounded text-xs font-medium ${actionBg} ${actionColor}">
                                ${trade.action}
                            </span>
                            <span class="font-medium">${trade.symbol}</span>
                            <span class="text-gray-600">â‚¹${formatNumber(trade.price)}</span>
                        </div>
                        <div class="text-sm text-gray-500 mt-1">
                            ${new Date(trade.timestamp).toLocaleString()}
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="font-medium">â‚¹${formatNumber(trade.total_value || 0)}</div>
                        <div class="text-sm text-gray-500">${trade.status}</div>
                    </div>
                `;
                
                tradesContainer.insertBefore(tradeElement, tradesContainer.firstChild);
            } catch (error) {
                console.error('Error adding trade to history:', error);
            }
        }

        function updateDisplay() {
            try {
                const lastUpdateElement = document.getElementById('lastUpdate');
                if (lastUpdateElement) {
                    lastUpdateElement.textContent = `Updated: ${new Date().toLocaleTimeString()}`;
                }
                
                // Update timestamps periodically
                setInterval(() => {
                    const lastUpdateElement = document.getElementById('lastUpdate');
                    if (lastUpdateElement) {
                        lastUpdateElement.textContent = `Updated: ${new Date().toLocaleTimeString()}`;
                    }
                }, 30000);
            } catch (error) {
                console.error('Error updating display:', error);
            }
        }
    </script>
</body>
</html>
